#!/usr/bin/env bash
set -e

# Include common setup
{% include 'common_setup.j2' %}

# Required packages
{% set required_packages = ['curl', 'systemctl'] %}
{% include 'package_validation.j2' %}

# Postgres specific installation
log_message "Installing PostgreSQL monitoring agent"

# Validate parameters
if [ -z "{{ parameters.db_host | default('') }}" ]; then
    error_exit "db_host parameter is required"
fi

if [ -z "{{ parameters.db_port | default('') }}" ]; then
    error_exit "db_port parameter is required"
fi

# Check if PostgreSQL is reachable
if ! pg_isready -h {{ parameters.db_host }} -p {{ parameters.db_port }}; then
    log_message "Warning: PostgreSQL not reachable at {{ parameters.db_host }}:{{ parameters.db_port }}"
fi

# Configure monitoring agent
mkdir -p /etc/newrelic-infra/integrations.d/
cat > /etc/newrelic-infra/integrations.d/postgres-config.yml <<EOF
integration_name: com.newrelic.postgresql
instances:
  - name: postgres-instance
    command: all_data
    arguments:
      host: {{ parameters.db_host }}
      port: {{ parameters.db_port }}
EOF

log_message "Postgres agent configuration complete"
log_message "Testing connection to database..."
psql -h {{ parameters.db_host }} -p {{ parameters.db_port }} -c "SELECT version();"

# Restart agent to apply configuration
if systemctl is-active --quiet newrelic-infra; then
    systemctl restart newrelic-infra
fi

log_message "PostgreSQL monitoring agent installed successfully" 