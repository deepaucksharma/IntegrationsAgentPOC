#!/bin/bash
# Infrastructure Agent Installation Script
# Generated by Workflow Agent v{{ version }}

set -e

# Configuration variables
LICENSE_KEY="{{ license_key }}"
HOST="{{ host }}"
PORT="{{ port }}"
INSTALL_DIR="{{ install_dir | default('/opt/newrelic-infra') }}"
CONFIG_DIR="{{ config_dir | default('/etc/newrelic-infra') }}"

echo "Starting New Relic Infrastructure Agent installation..."

# Create directories
mkdir -p "${INSTALL_DIR}"
mkdir -p "${CONFIG_DIR}"

{% if is_windows %}
# Windows installation
echo "Detected Windows system"
powershell -Command "& {
    # Download the installer
    $installerUrl = 'https://download.newrelic.com/infrastructure_agent/windows/newrelic-infra.msi'
    $installerPath = '$env:TEMP\newrelic-infra.msi'
    Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath

    # Install the agent
    Start-Process msiexec.exe -ArgumentList '/i', $installerPath, '/qn', 'GENERATE_CONFIG=true', 'LICENSE_KEY=$LICENSE_KEY' -Wait

    # Configure the agent
    $configPath = 'C:\Program Files\New Relic\newrelic-infra\newrelic-infra.yml'
    @'
license_key: $LICENSE_KEY
custom_attributes:
  host: $HOST
  port: $PORT
'@ | Out-File -FilePath $configPath -Encoding UTF8

    # Start the service
    Start-Service -Name 'newrelic-infra'
}"

{% else %}
# Linux installation
echo "Detected Linux system"

# Add New Relic repository
if command -v apt-get &> /dev/null; then
    # Debian/Ubuntu
    curl -s https://download.newrelic.com/infrastructure_agent/gpg/newrelic-infra.gpg | gpg --dearmor > /etc/apt/trusted.gpg.d/newrelic-infra.gpg
    echo "deb [arch=amd64] https://download.newrelic.com/infrastructure_agent/linux/apt focal main" > /etc/apt/sources.list.d/newrelic-infra.list
    apt-get update
    apt-get install -y newrelic-infra
elif command -v yum &> /dev/null; then
    # RHEL/CentOS
    curl -o /etc/yum.repos.d/newrelic-infra.repo https://download.newrelic.com/infrastructure_agent/linux/yum/el/7/x86_64/newrelic-infra.repo
    yum -y install newrelic-infra
else
    echo "Unsupported package manager"
    exit 1
fi

# Configure the agent
cat > "${CONFIG_DIR}/newrelic-infra.yml" << EOL
license_key: ${LICENSE_KEY}
custom_attributes:
  host: ${HOST}
  port: ${PORT}
EOL

# Start the agent
systemctl enable newrelic-infra
systemctl start newrelic-infra
{% endif %}

echo "New Relic Infrastructure Agent installation completed successfully" 