# Common PowerShell macros for error handling and logging

function log_message {
    param(
        [string]$level,
        [string]$message
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "$timestamp [$level] $message"
    Write-Host $logMessage
    Add-Content -Path $LOG_FILE -Value $logMessage
}

function handle_error {
    param(
        [string]$message
    )
    log_message "ERROR" $message
    throw $message
}

function check_prerequisites {
    param(
        [string[]]$required_tools
    )
    foreach ($tool in $required_tools) {
        if (-not (Get-Command $tool -ErrorAction SilentlyContinue)) {
            handle_error "Required tool not found: $tool"
        }
    }
}

{% macro setup_logging() %}
function Write-Log {
    param(
        [string]$Level,
        [string]$Message
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] $Level - $Message"
}

function Write-Info {
    param([string]$Message)
    Write-Log -Level "INFO" -Message $Message
}

function Write-Error {
    param([string]$Message)
    Write-Log -Level "ERROR" -Message $Message
    throw $Message
}
{% endmacro %}

{% macro error_handling() %}
trap {
    Write-Error "An error occurred: $_"
    exit 1
}
{% endmacro %}

{% macro check_prerequisites() %}
# Check if running as administrator
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (-not $isAdmin) {
    Write-Error "This script must be run as Administrator"
    exit 1
}
{% endmacro %} 