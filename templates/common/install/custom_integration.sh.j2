#!/bin/bash
# Custom Integration Installation Script
# Generated by Workflow Agent v{{ version }}

{% import 'macros/common.sh.j2' as common %}

{{ common.setup_logging() }}
{{ common.error_handling() }}

# Configuration variables
INTEGRATION_URL="{{ integration_url }}"
CONFIG_PATH="{{ config_path }}"

{{ common.log_message('INFO', 'Starting custom integration installation...') }}

{% if is_windows %}
# Windows installation
{{ common.log_message('INFO', 'Detected Windows system') }}
powershell -Command "& {
    # Create config directory if it doesn't exist
    $configDir = '${CONFIG_PATH}'
    if (-not (Test-Path $configDir)) {
        New-Item -ItemType Directory -Path $configDir -Force
    }

    # Download integration
    $integrationPath = Join-Path $configDir 'custom-integration.ps1'
    Invoke-WebRequest -Uri '${INTEGRATION_URL}' -OutFile $integrationPath

    # Set execution policy for the script
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

    # Register scheduled task to run integration
    $action = New-ScheduledTaskAction -Execute 'powershell.exe' -Argument "-File $integrationPath"
    $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 5)
    Register-ScheduledTask -TaskName 'CustomIntegration' -Action $action -Trigger $trigger -RunLevel Highest -Force
}"

{% else %}
# Linux installation
{{ common.log_message('INFO', 'Detected Linux system') }}

# Create config directory
mkdir -p "${CONFIG_PATH}"

# Download integration
curl -L "${INTEGRATION_URL}" -o "${CONFIG_PATH}/custom-integration.sh"
chmod +x "${CONFIG_PATH}/custom-integration.sh"

# Create systemd service
cat > /etc/systemd/system/custom-integration.service << EOL
[Unit]
Description=Custom Integration Service
After=network.target

[Service]
Type=simple
ExecStart=${CONFIG_PATH}/custom-integration.sh
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOL

# Enable and start service
systemctl daemon-reload
systemctl enable custom-integration
systemctl start custom-integration
{% endif %}

{{ common.log_message('INFO', 'Custom integration installation completed successfully') }} 