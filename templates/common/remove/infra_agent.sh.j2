#!/bin/bash
# Infrastructure Agent Uninstallation Script
# Generated by Workflow Agent v{{ version }}

set -e

# Configuration variables
INSTALL_DIR="{{ install_dir | default('/opt/newrelic-infra') }}"
CONFIG_DIR="{{ config_dir | default('/etc/newrelic-infra') }}"

echo "Starting New Relic Infrastructure Agent uninstallation..."

{% if is_windows %}
# Windows uninstallation
echo "Detected Windows system"
powershell -Command "& {
    # Stop the service
    Stop-Service -Name 'newrelic-infra' -ErrorAction SilentlyContinue

    # Get the product ID
    $app = Get-WmiObject -Class Win32_Product | Where-Object { $_.Name -like '*New Relic Infrastructure*' }
    if ($app) {
        # Uninstall the agent
        $app.Uninstall()
    } else {
        Write-Warning 'New Relic Infrastructure not found in installed programs'
    }

    # Remove configuration directory
    Remove-Item -Path 'C:\Program Files\New Relic\newrelic-infra' -Recurse -Force -ErrorAction SilentlyContinue
    Remove-Item -Path 'C:\ProgramData\New Relic\newrelic-infra' -Recurse -Force -ErrorAction SilentlyContinue
}"

{% else %}
# Linux uninstallation
echo "Detected Linux system"

# Stop and disable service
systemctl stop newrelic-infra || true
systemctl disable newrelic-infra || true

# Remove package based on package manager
if command -v apt-get &> /dev/null; then
    # Debian/Ubuntu
    apt-get remove -y newrelic-infra
    apt-get purge -y newrelic-infra
    rm -f /etc/apt/sources.list.d/newrelic-infra.list
    rm -f /etc/apt/trusted.gpg.d/newrelic-infra.gpg
elif command -v yum &> /dev/null; then
    # RHEL/CentOS
    yum remove -y newrelic-infra
    rm -f /etc/yum.repos.d/newrelic-infra.repo
else
    echo "Warning: Unsupported package manager"
fi

# Remove directories
rm -rf "${INSTALL_DIR}"
rm -rf "${CONFIG_DIR}"
rm -f /etc/systemd/system/newrelic-infra.service

# Reload systemd
systemctl daemon-reload
{% endif %}

echo "New Relic Infrastructure Agent uninstallation completed successfully" 